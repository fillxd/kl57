<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminarz Klasy</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        h1 {
            color: #2c3e50;
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .add-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .add-button:hover {
            background-color: #2980b9;
        }

        .calendar {
            width: 100%;
            border-collapse: collapse;
        }

        .calendar th {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: center;
        }

        .calendar th.weekend {
            background-color: #34495e;
        }

        .calendar td {
            border: 1px solid #ddd;
            padding: 10px;
            height: 120px;
            vertical-align: top;
            position: relative;
        }

        .calendar td.weekend {
            background-color: #f8f9fa;
            color: #95a5a6;
        }

        .calendar td.empty {
            background-color: #f9f9f9;
        }

        .day-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-weight: bold;
            color: #555;
        }

        .weekend .day-number {
            color: #95a5a6;
        }

        .event {
            margin-top: 5px;
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
        }

        .absence {
            background-color: #e74c3c;
            color: white;
        }

        .substitution {
            background-color: #3498db;
            color: white;
        }

        .cancelled {
            background-color: #7f8c8d;
            color: white;
        }

        .quiz {
            background-color: #2ecc71;
            color: white;
        }

        .exam {
            background-color: #f39c12;
            color: white;
        }

        .holiday {
            background-color: #9b59b6;
            color: white;
        }
        
        .class-absence {
            background-color: #e74c3c;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #777;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .date-range {
            display: flex;
            gap: 10px;
        }

        .date-range input {
            flex: 1;
        }
        
        .time-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .time-range input[type="time"] {
            flex: 1;
        }
        
        .time-range input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .event-details {
            margin-top: 15px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .event-details p {
            margin-bottom: 8px;
        }

        .event-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .event-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .event-type {
            flex: 1;
            min-width: 120px;
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .event-type.selected {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .menu {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #222;
            padding: 10px 15px;
            border-radius: 8px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .menu a {
            color: white;
            text-decoration: none;
            margin-bottom: 8px;
            font-family: Arial, sans-serif;
        }
        
        .menu a:hover {
            text-decoration: underline;
        }
        
        /* Styl dla zak≈Çadki Aktualno≈õci */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid #3498db;
            color: #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .news-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        
        .news-item:last-child {
            border-bottom: none;
        }
        
        .news-time {
            color: #777;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .news-action {
            font-weight: bold;
            color: #2c3e50;
        }
    </style>
</head>
<body>
<div class="menu">
    <a href="https://fillxd.github.io/sz57">Syst</a>
    <a href="https://fillxd.github.io/tm57">TM</a>
    <a href="https://fillxd.github.io/pl57">Plan</a>
        <a href="https://fillxd.github.io/na57">MG</a>
    <a href="https://fillxd.github.io/tk57">D5b</a>
    <a href="https://fillxd.github.io/kl57">T5b</a>
 <a href="https://docs.google.com/spreadsheets/d/18OV9Sar_ENFseGPn8wppwrIeJXm6j4dsa890OTg6Ioo/edit?gid=1302175797#gid=1302175797">ARK</a>
</div>

    <div class="container">
        <header>
            <h1>Terminarz Klasy 5b</h1>
            <div class="month-selector">
                <label for="month-select">MiesiƒÖc:</label>
                <select id="month-select">
                    <option value="2025-09">Wrzesie≈Ñ 2025</option>
                    <option value="2025-10">Pa≈∫dziernik 2025</option>
                    <option value="2025-11">Listopad 2025</option>
                    <option value="2025-12">Grudzie≈Ñ 2025</option>
                    <option value="2026-01">Stycze≈Ñ 2026</option>
                    <option value="2026-02">Luty 2026</option>
                    <option value="2026-03">Marzec 2026</option>
                    <option value="2026-04">Kwiecie≈Ñ 2026</option>
                    <option value="2026-05">Maj 2026</option>
                    <option value="2026-06">Czerwiec 2026</option>
                </select>
            </div>
            <button class="add-button" id="add-event-btn">DODAJ</button>
        </header>

        <!-- Zak≈Çadki Terminarz i Aktualno≈õci -->
        <div class="tabs">
            <button class="tab active" data-tab="calendar">Terminarz</button>
            <button class="tab" data-tab="news">Aktualno≈õci</button>
        </div>

        <!-- Zawarto≈õƒá zak≈Çadek -->
        <div class="tab-content active" id="calendar-tab">
            <table class="calendar">
                <thead>
                    <tr>
                        <th>Poniedzia≈Çek</th>
                        <th>Wtorek</th>
                        <th>≈öroda</th>
                        <th>Czwartek</th>
                        <th>PiƒÖtek</th>
                        <th class="weekend">Sobota</th>
                        <th class="weekend">Niedziela</th>
                    </tr>
                </thead>
                <tbody id="calendar-body">
                    <!-- Calendar will be generated here -->
                </tbody>
            </table>
        </div>

        <div class="tab-content" id="news-tab">
            <div id="news-container">
                <!-- Aktualno≈õci bƒôdƒÖ generowane tutaj -->
            </div>
        </div>
    </div>

    <!-- Modal for adding events -->
    <div class="modal" id="event-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Dodaj wydarzenie</h2>
                <button class="close-button" id="close-modal">&times;</button>
            </div>
            <div id="modal-body">
                <!-- Content will be dynamically filled -->
            </div>
        </div>
    </div>

    <!-- Add Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration dla strony klasy
        const firebaseConfigClass = {
            apiKey: "AIzaSyAJ8YuMwQ6j4zpZrWDrP3LLw8ztETKkOUY",
            authDomain: "ak57-3fb7e.firebaseapp.com",
            databaseURL: "https://ak57-3fb7e-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ak57-3fb7e",
            storageBucket: "ak57-3fb7e.firebasestorage.app",
            messagingSenderId: "963640904705",
            appId: "1:963640904705:web:2baa6712b3cb1ddc5f0400"
        };

        // Firebase configuration dla g≈Ç√≥wnego terminarza
        const firebaseConfigMain = {
            apiKey: "AIzaSyCzyqI6k2xHGM9mecAyGNJfAq7XjTKWqHs",
            authDomain: "na57-a08ec.firebaseapp.com",
            databaseURL: "https://na57-a08ec-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "na57-a08ec",
            storageBucket: "na57-a08ec.firebasestorage.app",
            messagingSenderId: "730540135505",
            appId: "1:730540135505:web:7a539a5eb3cb3d148d9470"
        };

        // Initialize Firebase dla strony klasy
        const appClass = firebase.initializeApp(firebaseConfigClass, 'classApp');
        const databaseClass = firebase.database(appClass);

        // Initialize Firebase dla g≈Ç√≥wnego terminarza
        const appMain = firebase.initializeApp(firebaseConfigMain, 'mainApp');
        const databaseMain = firebase.database(appMain);

        // Data storage
        let events = {};
        let importedEvents = {};
        let news = [];
        let currentEditingEvent = null;
        let currentEditingDate = null;
        let currentEditingIndex = null;
        
        // Lista nauczycieli tej klasy
        const classTeachers = [
            "Micha≈Ç Tarczyn",
            "Oliwia ≈ªabkiewicz",
            "Mateusz Gig",
            "Zofia Lisek",
            "Zuzanna ≈öwierczek",
            "Micha≈Ç Pietruszewski",
            "Ignacy W≈Çoszek",
            "Lena Skwierzy≈Ñska",
            "Barbara Trzaskowska",
            "Ludwik Parkowiak",
            "Karolina ≈ªukowska",
            "El≈ºbieta Gawin",
            "Hanna Brzeska"
        ];
        
        // DOM elements
        const monthSelect = document.getElementById('month-select');
        const calendarBody = document.getElementById('calendar-body');
        const addEventBtn = document.getElementById('add-event-btn');
        const eventModal = document.getElementById('event-modal');
        const closeModal = document.getElementById('close-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const newsContainer = document.getElementById('news-container');
        
        // Load events from Firebase (w≈Çasne wydarzenia klasy)
        function loadClassEvents() {
            return new Promise((resolve) => {
                databaseClass.ref('schoolCalendarEvents').on('value', (snapshot) => {
                    const data = snapshot.val();
                    events = data || {};
                    resolve(events);
                });
            });
        }
        
        // Load events from main calendar (g≈Ç√≥wny terminarz)
        function loadMainCalendarEvents() {
            return new Promise((resolve) => {
                databaseMain.ref('schoolCalendarEvents').on('value', (snapshot) => {
                    const mainEvents = snapshot.val() || {};
                    importedEvents = {};
                    
                    // Filtruj tylko dni wolne i nieobecno≈õci nauczycieli tej klasy
                    Object.keys(mainEvents).forEach(date => {
                        mainEvents[date].forEach(event => {
                            if (event.type === 'holiday') {
                                // Importuj wszystkie dni wolne
                                if (!importedEvents[date]) importedEvents[date] = [];
                                importedEvents[date].push({
                                    ...event,
                                    imported: true,
                                    source: 'main'
                                });
                            } else if (event.type === 'absence' && classTeachers.includes(event.teacher)) {
                                // Importuj tylko nieobecno≈õci nauczycieli tej klasy
                                if (!importedEvents[date]) importedEvents[date] = [];
                                importedEvents[date].push({
                                    ...event,
                                    imported: true,
                                    source: 'main'
                                });
                            }
                        });
                    });
                    
                    resolve(importedEvents);
                });
            });
        }
		
        // Track changes in main calendar for news - tylko dla klasy 5b
        function trackMainCalendarChanges() {
            databaseMain.ref('schoolCalendarNews').on('value', (snapshot) => {
                const mainNews = snapshot.val() || [];
                
                // Filtruj tylko aktualno≈õci dotyczƒÖce klasy 5b
                const filteredNews = mainNews.filter(item => {
                    // Sprawdzamy czy aktualno≈õƒá dotyczy nieobecno≈õci nauczyciela z naszej klasy
                    if (item.action && item.action.includes('nieobecno≈õƒá') && item.details) {
                        return classTeachers.some(teacher => item.details.includes(teacher));
                    }
                    // Importuj tylko wycieczki klasy 5b
                    if (item.action && (item.action.includes('wycieczka') || item.action.includes('Wycieczka'))) {
                        return item.details && (item.details.includes('5b') || item.details.toLowerCase().includes('klasa 5b'));
                    }
                    // Importuj tylko dni wolne szko≈Çy lub dni wolne klasy 5b
                    if (item.action && item.action.includes('dzie≈Ñ wolny')) {
                        // Je≈õli w szczeg√≥≈Çach jest wzmianka o klasie
                        if (item.details && (item.details.includes('klasa') || item.details.includes('Klasa'))) {
                            // Sprawdzamy czy to dzie≈Ñ wolny dla klasy 5b
                            return item.details.includes('5b') || item.details.toLowerCase().includes('klasa 5b');
                        }
                        // Je≈õli nie ma wzmianki o klasie, to jest to dzie≈Ñ wolny szko≈Çy (dla wszystkich)
                        return true;
                    }
                    return false;
                });
                
                // Oznacz przefiltrowane jako zaimportowane
                const importedNews = filteredNews.map(item => ({
                    ...item,
                    imported: true,
                    source: 'main'
                }));
                
                // Po≈ÇƒÖcz z w≈Çasnymi aktualno≈õciami (unikaj duplikat√≥w na podstawie timestamp)
                const existingTimestamps = new Set(news.map(item => item.timestamp));
                const newImportedNews = importedNews.filter(item => !existingTimestamps.has(item.timestamp));
                
                news = [...newImportedNews, ...news];
                
                // Posortuj i ogranicz
                news.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                news = news.slice(0, 100);
                
                displayNews();
            });
        }
        
        // Load news from Firebase
        function loadNews() {
            return new Promise((resolve) => {
                databaseClass.ref('schoolCalendarNews').on('value', (snapshot) => {
                    const data = snapshot.val();
                    news = data || [];
                    resolve(news);
                });
            });
        }
        
        // Save events to Firebase (tylko w≈Çasne wydarzenia klasy)
        function saveEvents() {
            return databaseClass.ref('schoolCalendarEvents').set(events);
        }
        
        // Save news to Firebase
        function saveNews() {
            return databaseClass.ref('schoolCalendarNews').set(news);
        }
        
        // Add news item
        function addNewsItem(action, details) {
            const newsItem = {
                action: action,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            news.unshift(newsItem);
            if (news.length > 100) {
                news = news.slice(0, 100);
            }
            
            return saveNews();
        }
		
        // Update calendar based on month selector
        function updateCalendarFromSelector() {
            const [year, month] = monthSelect.value.split('-').map(Number);
            generateCalendar(year, month - 1); // month - 1 bo miesiƒÖce sƒÖ 0-11
        }

        async function initCalendar() {
            // Load events and news from Firebase
            await Promise.all([loadClassEvents(), loadMainCalendarEvents(), loadNews()]);
            
            // Start tracking main calendar changes
            trackMainCalendarChanges();
            
            // Ustaw aktualny miesiƒÖc i rok
            const now = new Date();
            const currentMonthValue = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            monthSelect.value = currentMonthValue;
            
            // Generuj kalendarz dla wybranego miesiƒÖca
            updateCalendarFromSelector();
            displayNews();
        }
        
        // Generate calendar for given month and year
        function generateCalendar(year, month) {
            calendarBody.innerHTML = '';
            
            const firstDay = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let firstDayOfWeek = firstDay.getDay();
            firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            
            let date = 1;
            let calendarHTML = '';
            
            for (let week = 0; week < 6; week++) {
                calendarHTML += '<tr>';
                
                for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                    if (week === 0 && dayOfWeek < firstDayOfWeek) {
                        calendarHTML += '<td class="empty"></td>';
                    } else if (date > daysInMonth) {
                        calendarHTML += '<td class="empty"></td>';
                    } else {
                        const currentDate = new Date(year, month, date);
                        const dayOfMonth = currentDate.getDate();
                        const isWeekend = dayOfWeek === 5 || dayOfWeek === 6;
                        
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayOfMonth).padStart(2, '0')}`;
                        const dayEvents = events[dateStr] || [];
                        const dayImportedEvents = importedEvents[dateStr] || [];
                        
                        const allDayEvents = [...dayEvents, ...dayImportedEvents];
                        
                        calendarHTML += `<td class="${isWeekend ? 'weekend' : ''}" data-date="${dateStr}">`;
                        calendarHTML += `<div class="day-number">${dayOfMonth}</div>`;
                        
                        allDayEvents.forEach((event, index) => {
                            let eventClass = '';
                            let eventText = '';
                            let isImported = event.imported;
                            
                            if (event.type === 'absence') {
                                eventClass = 'absence';
                                eventText = `Nieobecno≈õƒá: ${event.teacher}`;
                                if (event.timeRange) {
                                    eventText += ` (${event.timeRange})`;
                                } else if (event.lessons) {
                                    eventText += ` (Lekcje ${event.lessons})`;
                                }
                                if (isImported) eventText = `üìã ${eventText}`;
                            } else if (event.type === 'substitution') {
                                eventClass = 'substitution';
                                eventText = `Zastƒôpstwo: ${event.originalSubject} > ${event.substitutionSubject} (${event.substitutingTeacher}) (lekcja ${event.lesson})`;
                            } else if (event.type === 'cancelled') {
                                eventClass = 'cancelled';
                                eventText = `Odwo≈Çana lekcja: ${event.subject || 'Lekcja'} (lekcja ${event.lesson})`;
                            } else if (event.type === 'quiz') {
                                eventClass = 'quiz';
                                eventText = `Kartk√≥wka: ${event.subject} (lekcja ${event.lesson})`;
                            } else if (event.type === 'exam') {
                                eventClass = 'exam';
                                eventText = `Sprawdzian: ${event.subject} (lekcja ${event.lesson})`;
                            } else if (event.type === 'holiday') {
                                eventClass = 'holiday';
                                eventText = `Dzie≈Ñ Wolny: ${event.title}`;
                                if (isImported) eventText = `üìã ${eventText}`;
                            } else if (event.type === 'class-absence') {
                                eventClass = 'class-absence';
                                eventText = `Nieobecno≈õƒá klasy 5B (${event.allDay ? 'Ca≈Çy dzie≈Ñ' : event.timeRange})`;
                            }
                            
                            calendarHTML += `<div class="event ${eventClass}" data-date="${dateStr}" data-index="${index}" data-imported="${isImported}">${eventText}</div>`;
                        });
                        
                        calendarHTML += '</td>';
                        date++;
                    }
                }
                
                calendarHTML += '</tr>';
                
                if (date > daysInMonth) {
                    break;
                }
            }
            
            calendarBody.innerHTML = calendarHTML;
            
            document.querySelectorAll('.event').forEach(eventEl => {
                eventEl.addEventListener('click', function() {
                    const date = this.getAttribute('data-date');
                    const index = parseInt(this.getAttribute('data-index'));
                    const isImported = this.getAttribute('data-imported') === 'true';
                    
                    if (!isImported) {
                        showEventDetails(date, index);
                    } else {
                        showImportedEventDetails(date, index);
                    }
                });
            });
        }
        
        // Display news
        function displayNews() {
            newsContainer.innerHTML = '';
            
            if (news.length === 0) {
                newsContainer.innerHTML = '<p>Brak aktualno≈õci.</p>';
                return;
            }
            
            news.forEach(item => {
                const newsItem = document.createElement('div');
                newsItem.className = 'news-item';
                
                const timeAgo = getTimeAgo(item.timestamp);
                const importedLabel = item.imported ? 'üìã ' : '';
                
                newsItem.innerHTML = `
                    <div class="news-action">${importedLabel}${item.action}</div>
                    <div>${item.details}</div>
                    <div class="news-time">${timeAgo}${item.imported ? ' ‚Ä¢ Zaimportowane z terminarza szkolnego' : ''}</div>
                `;
                
                newsContainer.appendChild(newsItem);
            });
        }
        
        // Calculate time ago
        function getTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffMs = now - past;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return 'Przed chwilƒÖ';
            } else if (diffMins < 60) {
                return `${diffMins} ${diffMins === 1 ? 'minutƒô' : diffMins < 5 ? 'minuty' : 'minut'} temu`;
            } else if (diffHours < 24) {
                return `${diffHours} ${diffHours === 1 ? 'godzinƒô' : diffHours < 5 ? 'godziny' : 'godzin'} temu`;
            } else if (diffDays < 7) {
                return `${diffDays} ${diffDays === 1 ? 'dzie≈Ñ' : 'dni'} temu`;
            } else {
                return past.toLocaleDateString('pl-PL');
            }
        }
        
        // Show event details for imported events (tylko podglƒÖd)
        function showImportedEventDetails(date, index) {
            const event = importedEvents[date][index];
            let detailsHTML = '';
            
            if (event.type === 'absence') {
                detailsHTML = `
                    <h3>Nieobecno≈õƒá (zaimportowane)</h3>
                    <div class="event-details">
                        <p><strong>Nauczyciel:</strong> ${event.teacher}</p>
                        <p><strong>Data:</strong> ${formatDate(event.startDate)}${event.endDate && event.endDate !== event.startDate ? ` - ${formatDate(event.endDate)}` : ''}</p>
                        ${event.timeRange ? `<p><strong>Godziny:</strong> ${event.timeRange}</p>` : ''}
                        ${event.reason ? `<p><strong>Pow√≥d:</strong> ${event.reason}</p>` : ''}
                        <p><strong>≈πr√≥d≈Ço:</strong> G≈Ç√≥wny terminarz szkolny</p>
                    </div>
                `;
            } else if (event.type === 'holiday') {
                detailsHTML = `
                    <h3>Dzie≈Ñ Wolny (zaimportowane)</h3>
                    <div class="event-details">
                        <p><strong>Tytu≈Ç:</strong> ${event.title}</p>
                        <p><strong>Data:</strong> ${formatDate(event.startDate)}${event.endDate && event.endDate !== event.startDate ? ` - ${formatDate(event.endDate)}` : ''}</p>
                        <p><strong>≈πr√≥d≈Ço:</strong> G≈Ç√≥wny terminarz szkolny</p>
                    </div>
                `;
            }
            
            detailsHTML += `
                <div class="event-actions">
                    <button class="btn btn-secondary" id="close-details">Zamknij</button>
                </div>
            `;
            
            modalTitle.textContent = 'Szczeg√≥≈Çy wydarzenia (zaimportowane)';
            modalBody.innerHTML = detailsHTML;
            
            document.getElementById('close-details').addEventListener('click', function() {
                eventModal.style.display = 'none';
            });
            
            eventModal.style.display = 'flex';
        }
        
        // Show event details for class events (mo≈ºliwo≈õƒá edycji)
        function showEventDetails(date, index) {
            const event = events[date][index];
            let detailsHTML = '';
            
            if (event.type === 'absence') {
                detailsHTML = `
                    <h3>Nieobecno≈õƒá</h3>
                    <div class="event-details">
                        <p><strong>Nauczyciel:</strong> ${event.teacher}</p>
                        <p><strong>Data:</strong> ${formatDate(event.startDate)}${event.endDate && event.endDate !== event.startDate ? ` - ${formatDate(event.endDate)}` : ''}</p>
                        ${event.lessons ? `<p><strong>Lekcje:</strong> ${event.lessons}</p>` : ''}
                        <p><strong>Dodano:</strong> ${formatDateTime(event.createdAt)}</p>
                    </div>
                `;
            } else if (event.type === 'substitution') {
                detailsHTML = `
                    <h3>Zastƒôpstwo</h3>
                    <div class="event-details">
                        <p><strong>Zastƒôpstwo:</strong> ${event.originalSubject} > ${event.substitutionSubject} (${event.substitutedTeacher} > ${event.substitutingTeacher}) (lekcja ${event.lesson})</p>
                        <p><strong>Data:</strong> ${formatDate(event.date)}</p>
                        <p><strong>Dodano:</strong> ${formatDateTime(event.createdAt)}</p>
                    </div>
                `;
            } else if (event.type === 'cancelled') {
                detailsHTML = `
                    <h3>Odwo≈Çana lekcja: ${event.subject || ''}</h3>
                    <div class="event-details">
                        <p><strong>Data:</strong> ${formatDate(event.date)}</p>
                        <p><strong>Lekcja:</strong> ${event.lesson}</p>
                        ${event.subject ? `<p><strong>Przedmiot:</strong> ${event.subject}</p>` : ''}
                        ${event.teacher ? `<p><strong>Nauczyciel:</strong> ${event.teacher}</p>` : ''}
                        ${event.reason ? `<p><strong>Pow√≥d:</strong> ${event.reason}</p>` : ''}
                        <p><strong>Dodano:</strong> ${formatDateTime(event.createdAt)}</p>
                    </div>
                `;
            } else if (event.type === 'quiz' || event.type === 'exam') {
                const eventType = event.type === 'quiz' ? 'Kartk√≥wka' : 'Sprawdzian';
                detailsHTML = `
                    <h3>${eventType}</h3>
                    <div class="event-details">
                        <p><strong>Przedmiot:</strong> ${event.subject}</p>
                        <p><strong>Data:</strong> ${formatDate(event.date)}</p>
                        <p><strong>Lekcja:</strong> ${event.lesson}</p>
                        <p><strong>Opis:</strong> ${event.description}</p>
                        <p><strong>Nauczyciel:</strong> ${event.teacher}</p>
                        <p><strong>Dodano:</strong> ${formatDateTime(event.createdAt)}</p>
                    </div>
                `;
            } else if (event.type === 'holiday') {
                detailsHTML = `
                    <h3>Dzie≈Ñ Wolny</h3>
                    <div class="event-details">
                        <p><strong>Tytu≈Ç:</strong> ${event.title}</p>
                        <p><strong>Data:</strong> ${formatDate(event.startDate)}${event.endDate && event.endDate !== event.startDate ? ` - ${formatDate(event.endDate)}` : ''}</p>
                        <p><strong>Dodano:</strong> ${formatDateTime(event.createdAt)}</p>
                    </div>
                `;
            } else if (event.type === 'class-absence') {
                detailsHTML = `
                    <h3>Nieobecno≈õƒá klasy</h3>
                    <div class="event-details">
                        <p><strong>Klasa:</strong> 5B</p>
                        <p><strong>Data:</strong> ${formatDate(event.startDate)}${event.endDate && event.endDate !== event.startDate ? ` - ${formatDate(event.endDate)}` : ''}</p>
                        <p><strong>Godziny:</strong> ${event.allDay ? 'Ca≈Çy dzie≈Ñ' : event.timeRange}</p>
                        ${event.description ? `<p><strong>Opis:</strong> ${event.description}</p>` : ''}
                        <p><strong>Dodano:</strong> ${formatDateTime(event.createdAt)}</p>
                    </div>
                `;
            }
            
            detailsHTML += `
                <div class="event-actions">
                    <button class="btn btn-primary" id="edit-event">Edytuj</button>
                    <button class="btn btn-danger" id="delete-event">Usu≈Ñ</button>
                </div>
            `;
            
            modalTitle.textContent = 'Szczeg√≥≈Çy wydarzenia';
            modalBody.innerHTML = detailsHTML;
            
            currentEditingEvent = event;
            currentEditingDate = date;
            currentEditingIndex = index;
            
            document.getElementById('edit-event').addEventListener('click', function() {
                showEventForm(event.type, true);
            });
            
            document.getElementById('delete-event').addEventListener('click', function() {
                if (confirm('Czy na pewno chcesz usunƒÖƒá to wydarzenie?')) {
                    // Add news item for deletion
                    let newsAction = '';
                    let newsDetails = '';
                    
                    if (currentEditingEvent.type === 'absence') {
                        newsAction = 'Usuniƒôto nieobecno≈õƒá nauczyciela';
                        const dateRange = currentEditingEvent.startDate === currentEditingEvent.endDate || !currentEditingEvent.endDate 
                            ? `w dniu ${formatDate(currentEditingEvent.startDate)}`
                            : `od ${formatDate(currentEditingEvent.startDate)} do ${formatDate(currentEditingEvent.endDate)}`;
                        newsDetails = `${currentEditingEvent.teacher} ${dateRange}`;
                    } else if (currentEditingEvent.type === 'substitution') {
                        newsAction = `Usuniƒôto zastƒôpstwo w dniu ${formatDate(currentEditingEvent.date)}.`;
                        newsDetails = `${currentEditingEvent.originalSubject} > ${currentEditingEvent.substitutionSubject} (${currentEditingEvent.substitutedTeacher} > ${currentEditingEvent.substitutingTeacher}) (lekcja ${currentEditingEvent.lesson})`;
                    } else if (currentEditingEvent.type === 'cancelled') {
                        newsAction = `Usuniƒôto odwo≈Çanie lekcji ${currentEditingEvent.subject || ''} w dniu ${formatDate(currentEditingEvent.date)}`;
                        newsDetails = `(lekcja ${currentEditingEvent.lesson})`;
                    } else if (currentEditingEvent.type === 'quiz') {
                        newsAction = `Usuniƒôto wydarzenie w dniu ${formatDate(currentEditingEvent.date)}: Kartk√≥wka`;
                        newsDetails = `Przedmiot: ${currentEditingEvent.subject} (lekcja ${currentEditingEvent.lesson})`;
                    } else if (currentEditingEvent.type === 'exam') {
                        newsAction = `Usuniƒôto wydarzenie w dniu ${formatDate(currentEditingEvent.date)}: Sprawdzian`;
                        newsDetails = `Przedmiot: ${currentEditingEvent.subject} (lekcja ${currentEditingEvent.lesson})`;
                    } else if (currentEditingEvent.type === 'holiday') {
                        newsAction = 'Usuniƒôto dzie≈Ñ wolny';
                        const dateRange = currentEditingEvent.startDate === currentEditingEvent.endDate || !currentEditingEvent.endDate 
                            ? `w dniu ${formatDate(currentEditingEvent.startDate)}`
                            : `od ${formatDate(currentEditingEvent.startDate)} do ${formatDate(currentEditingEvent.endDate)}`;
                        newsDetails = `"${currentEditingEvent.title}" ${dateRange}`;
                    } else if (currentEditingEvent.type === 'class-absence') {
                        const timeInfo = currentEditingEvent.allDay ? '' : ` w godzinach ${currentEditingEvent.timeRange}`;
                        newsAction = `Usuniƒôto nieobecno≈õƒá klasy w dniu ${formatDate(currentEditingEvent.startDate)}${timeInfo}`;
                        newsDetails = currentEditingEvent.description || '';
                    }
                    
                    // For range events, we need to remove from all dates
                    if (currentEditingEvent.type === 'absence' || currentEditingEvent.type === 'holiday' || currentEditingEvent.type === 'class-absence') {
                        const startDate = new Date(currentEditingEvent.startDate);
                        const endDate = new Date(currentEditingEvent.endDate || currentEditingEvent.startDate);
                        
                        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                            const dateKey = formatDateForStorage(d);
                            if (events[dateKey]) {
                                events[dateKey] = events[dateKey].filter(e => 
                                    !(e.type === currentEditingEvent.type && 
                                      e.startDate === currentEditingEvent.startDate)
                                );
                                if (events[dateKey].length === 0) {
                                    delete events[dateKey];
                                }
                            }
                        }
                    } else {
                        // For single date events
                        events[date].splice(index, 1);
                        if (events[date].length === 0) {
                            delete events[date];
                        }
                    }
                    
                    addNewsItem(newsAction, newsDetails).then(() => {
                        saveEvents().then(() => {
                            initCalendar();
                            eventModal.style.display = 'none';
                            resetEditingContext();
                        });
                    });
                }
            });
            
            eventModal.style.display = 'flex';
        }
        
        // Show event form
        function showEventForm(type = null, isEdit = false) {
            if (!type && !isEdit) {
                modalTitle.textContent = 'Dodaj wydarzenie';
                modalBody.innerHTML = `
                    <div class="event-type-selector">
                        <div class="event-type" data-type="absence">Nieobecno≈õƒá nauczyciela</div>
                        <div class="event-type" data-type="class-absence">Nieobecno≈õƒá klasy</div>
                        <div class="event-type" data-type="substitution">Zastƒôpstwo</div>
                        <div class="event-type" data-type="cancelled">Odwo≈Çana lekcja</div>
                        <div class="event-type" data-type="quiz">Kartk√≥wka</div>
                        <div class="event-type" data-type="exam">Sprawdzian</div>
                        <div class="event-type" data-type="holiday">Dzie≈Ñ Wolny</div>
                    </div>
                `;
                
                document.querySelectorAll('.event-type').forEach(button => {
                    button.addEventListener('click', function() {
                        const selectedType = this.getAttribute('data-type');
                        showSpecificEventForm(selectedType, false);
                    });
                });
            } else {
                showSpecificEventForm(type, isEdit);
            }
            
            eventModal.style.display = 'flex';
        }
        
        // Show specific event form based on type
        function showSpecificEventForm(type, isEdit = false) {
            let formHTML = '';
            const eventData = isEdit ? currentEditingEvent : null;
            
            modalTitle.textContent = isEdit ? 'Edytuj wydarzenie' : 'Dodaj wydarzenie';
            
            if (type === 'absence') {
                formHTML = `
                    <div class="form-group">
                        <label for="absence-teacher">Nauczyciel:</label>
                        <input type="text" id="absence-teacher" value="${isEdit ? eventData.teacher : ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Data nieobecno≈õci:</label>
                        <div class="date-range">
                            <input type="date" id="absence-start-date" value="${isEdit ? eventData.startDate : ''}" required>
                            <input type="date" id="absence-end-date" value="${isEdit ? eventData.endDate || eventData.startDate : ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="absence-lessons">Lekcje (np. 1-5):</label>
                        <input type="text" id="absence-lessons" value="${isEdit ? eventData.lessons || '' : ''}">
                    </div>
                `;
            } else if (type === 'class-absence') {
                formHTML = `
                    <div class="form-group">
                        <label>Data nieobecno≈õci klasy:</label>
                        <div class="date-range">
                            <input type="date" id="class-absence-start-date" value="${isEdit ? eventData.startDate : ''}" required>
                            <input type="date" id="class-absence-end-date" value="${isEdit ? eventData.endDate || eventData.startDate : ''}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Godziny nieobecno≈õci:</label>
                        <div class="time-range">
                            <input type="checkbox" id="all-day" ${isEdit && eventData.allDay ? 'checked' : ''}>
                            <label for="all-day" style="display: inline; margin: 0;">Ca≈Çy dzie≈Ñ</label>
                        </div>
                        <div class="time-range" id="time-inputs" style="${isEdit && eventData.allDay ? 'display: none;' : ''}margin-top: 10px;">
                            <input type="time" id="start-time" value="${isEdit && eventData.startTime ? eventData.startTime : '08:00'}">
                            <span>do</span>
                            <input type="time" id="end-time" value="${isEdit && eventData.endTime ? eventData.endTime : '15:00'}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="class-absence-description">Opis (opcjonalnie):</label>
                        <textarea id="class-absence-description">${isEdit ? eventData.description || '' : ''}</textarea>
                    </div>
                `;
            } else if (type === 'substitution') {
                formHTML = `
                    <div class="form-group">
                        <label for="substituted-teacher">Nauczyciel zastƒôpowany:</label>
                        <input type="text" id="substituted-teacher" value="${isEdit ? eventData.substitutedTeacher : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="original-subject">Przedmiot zastƒôpowany:</label>
                        <input type="text" id="original-subject" value="${isEdit ? eventData.originalSubject : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="substituting-teacher">Nauczyciel zastƒôpujƒÖcy:</label>
                        <input type="text" id="substituting-teacher" value="${isEdit ? eventData.substitutingTeacher : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="substitution-subject">Przedmiot na zastƒôpstwie:</label>
                        <input type="text" id="substitution-subject" value="${isEdit ? eventData.substitutionSubject : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="substitution-date">Data zastƒôpstwa:</label>
                        <input type="date" id="substitution-date" value="${isEdit ? eventData.date : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="substitution-lesson">Lekcja:</label>
                        <input type="number" id="substitution-lesson" min="1" max="10" value="${isEdit ? eventData.lesson : ''}" required>
                    </div>
                `;
            } else if (type === 'cancelled') {
                formHTML = `
                    <div class="form-group">
                        <label for="cancelled-date">Data odwo≈Çanej lekcji:</label>
                        <input type="date" id="cancelled-date" value="${isEdit ? eventData.date : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="cancelled-lesson">Numer lekcji:</label>
                        <input type="number" id="cancelled-lesson" min="1" max="10" value="${isEdit ? eventData.lesson : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="cancelled-subject">Przedmiot (opcjonalnie):</label>
                        <input type="text" id="cancelled-subject" value="${isEdit ? eventData.subject || '' : ''}">
                    </div>
                    <div class="form-group">
                        <label for="cancelled-teacher">Nauczyciel (opcjonalnie):</label>
                        <input type="text" id="cancelled-teacher" value="${isEdit ? eventData.teacher || '' : ''}">
                    </div>
                    <div class="form-group">
                        <label for="cancelled-reason">Pow√≥d (opcjonalnie):</label>
                        <textarea id="cancelled-reason">${isEdit ? eventData.reason || '' : ''}</textarea>
                    </div>
                `;
            } else if (type === 'quiz' || type === 'exam') {
                formHTML = `
                    <div class="form-group">
                        <label for="event-subject">Przedmiot:</label>
                        <input type="text" id="event-subject" value="${isEdit ? eventData.subject : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="event-date">Data:</label>
                        <input type="date" id="event-date" value="${isEdit ? eventData.date : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="event-lesson">Lekcja:</label>
                        <input type="number" id="event-lesson" min="1" max="10" value="${isEdit ? eventData.lesson : ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="event-description">Opis:</label>
                        <textarea id="event-description">${isEdit ? eventData.description : ''}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="event-teacher">Nauczyciel:</label>
                        <input type="text" id="event-teacher" value="${isEdit ? eventData.teacher : ''}" required>
                    </div>
                `;
            } else if (type === 'holiday') {
                formHTML = `
                    <div class="form-group">
                        <label for="holiday-title">Tytu≈Ç dnia wolnego:</label>
                        <input type="text" id="holiday-title" value="${isEdit ? eventData.title : ''}" required>
                    </div>
                    <div class="form-group">
                        <label>Data dnia wolnego:</label>
                        <div class="date-range">
                            <input type="date" id="holiday-start-date" value="${isEdit ? eventData.startDate : ''}" required>
                            <input type="date" id="holiday-end-date" value="${isEdit ? eventData.endDate || eventData.startDate : ''}">
                        </div>
                    </div>
                `;
            }
            
            formHTML += `
                <div class="form-actions">
                    <button class="btn btn-secondary" id="cancel-form">Anuluj</button>
                    <button class="btn btn-primary" id="save-event">${isEdit ? 'Zapisz zmiany' : 'Dodaj'}</button>
                </div>
            `;
            
            modalBody.innerHTML = formHTML;
            
            // Add event listener for all-day checkbox if it's class absence
            if (type === 'class-absence') {
                const allDayCheckbox = document.getElementById('all-day');
                const timeInputs = document.getElementById('time-inputs');
                
                allDayCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        timeInputs.style.display = 'none';
                    } else {
                        timeInputs.style.display = 'flex';
                    }
                });
            }
            
            document.getElementById('cancel-form').addEventListener('click', function() {
                eventModal.style.display = 'none';
                resetEditingContext();
            });
            
            document.getElementById('save-event').addEventListener('click', function() {
                saveEvent(type, isEdit);
            });
        }
        
        // Save event
        function saveEvent(type, isEdit = false) {
            const eventData = {
                type: type,
                createdAt: isEdit ? currentEditingEvent.createdAt : new Date().toISOString()
            };
            
            if (type === 'absence') {
                eventData.teacher = document.getElementById('absence-teacher').value;
                eventData.startDate = document.getElementById('absence-start-date').value;
                eventData.endDate = document.getElementById('absence-end-date').value || eventData.startDate;
                eventData.lessons = document.getElementById('absence-lessons').value;
                
                if (!eventData.teacher || !eventData.startDate) {
                    alert('Proszƒô wype≈Çniƒá wymagane pola');
                    return;
                }
            } else if (type === 'class-absence') {
                eventData.startDate = document.getElementById('class-absence-start-date').value;
                eventData.endDate = document.getElementById('class-absence-end-date').value || eventData.startDate;
                eventData.allDay = document.getElementById('all-day').checked;
                eventData.description = document.getElementById('class-absence-description').value;
                
                if (!eventData.allDay) {
                    const startTime = document.getElementById('start-time').value;
                    const endTime = document.getElementById('end-time').value;
                    eventData.startTime = startTime;
                    eventData.endTime = endTime;
                    eventData.timeRange = `${startTime}-${endTime}`;
                }
                
                if (!eventData.startDate) {
                    alert('Proszƒô wype≈Çniƒá datƒô');
                    return;
                }
            } else if (type === 'substitution') {
                eventData.substitutedTeacher = document.getElementById('substituted-teacher').value;
                eventData.originalSubject = document.getElementById('original-subject').value;
                eventData.substitutingTeacher = document.getElementById('substituting-teacher').value;
                eventData.substitutionSubject = document.getElementById('substitution-subject').value;
                eventData.date = document.getElementById('substitution-date').value;
                eventData.lesson = document.getElementById('substitution-lesson').value;
                
                if (!eventData.substitutedTeacher || !eventData.originalSubject || 
                    !eventData.substitutingTeacher || !eventData.substitutionSubject || 
                    !eventData.date || !eventData.lesson) {
                    alert('Proszƒô wype≈Çniƒá wszystkie pola');
                    return;
                }
            } else if (type === 'cancelled') {
                eventData.date = document.getElementById('cancelled-date').value;
                eventData.lesson = document.getElementById('cancelled-lesson').value;
                eventData.subject = document.getElementById('cancelled-subject').value;
                eventData.teacher = document.getElementById('cancelled-teacher').value;
                eventData.reason = document.getElementById('cancelled-reason').value;
                
                if (!eventData.date || !eventData.lesson) {
                    alert('Proszƒô wype≈Çniƒá wymagane pola');
                    return;
                }
            } else if (type === 'quiz' || type === 'exam') {
                eventData.subject = document.getElementById('event-subject').value;
                eventData.date = document.getElementById('event-date').value;
                eventData.lesson = document.getElementById('event-lesson').value;
                eventData.description = document.getElementById('event-description').value;
                eventData.teacher = document.getElementById('event-teacher').value;
                
                if (!eventData.subject || !eventData.date || !eventData.lesson || !eventData.teacher) {
                    alert('Proszƒô wype≈Çniƒá wymagane pola');
                    return;
                }
            } else if (type === 'holiday') {
                eventData.title = document.getElementById('holiday-title').value;
                eventData.startDate = document.getElementById('holiday-start-date').value;
                eventData.endDate = document.getElementById('holiday-end-date').value || eventData.startDate;
                
                if (!eventData.title || !eventData.startDate) {
                    alert('Proszƒô wype≈Çniƒá wymagane pola');
                    return;
                }
            }
            
            if (isEdit) {
                // For editing, first remove the old event
                if (currentEditingEvent.type === 'absence' || currentEditingEvent.type === 'holiday' || currentEditingEvent.type === 'class-absence') {
                    const startDate = new Date(currentEditingEvent.startDate);
                    const endDate = new Date(currentEditingEvent.endDate || currentEditingEvent.startDate);
                    
                    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                        const dateKey = formatDateForStorage(d);
                        if (events[dateKey]) {
                            events[dateKey] = events[dateKey].filter(e => 
                                !(e.type === currentEditingEvent.type && 
                                  e.startDate === currentEditingEvent.startDate)
                            );
                            if (events[dateKey].length === 0) {
                                delete events[dateKey];
                            }
                        }
                    }
                } else {
                    events[currentEditingDate].splice(currentEditingIndex, 1);
                    if (events[currentEditingDate].length === 0) {
                        delete events[currentEditingDate];
                    }
                }
            }
            
            // Add news item
            let newsAction = '';
            let newsDetails = '';
            
            if (type === 'absence') {
                newsAction = isEdit ? 'Zmieniono nieobecno≈õƒá nauczyciela' : 'Dodano nieobecno≈õƒá nauczyciela';
                const dateRange = eventData.startDate === eventData.endDate 
                    ? `w dniu ${formatDate(eventData.startDate)}`
                    : `od ${formatDate(eventData.startDate)} do ${formatDate(eventData.endDate)}`;
                newsDetails = `${eventData.teacher} ${dateRange}`;
            } else if (type === 'class-absence') {
                const timeInfo = eventData.allDay ? '' : ` w godzinach ${eventData.timeRange}`;
                newsAction = isEdit 
                    ? `Zmieniono nieobecno≈õƒá klasy w dniu ${formatDate(eventData.startDate)}${timeInfo}`
                    : `Dodano nieobecno≈õƒá klasy w dniu ${formatDate(eventData.startDate)}${timeInfo}`;
                newsDetails = eventData.description || '';
            } else if (type === 'substitution') {
                const actionVerb = isEdit ? 'Zmieniono' : 'Dodano';
                newsAction = `${actionVerb} zastƒôpstwo w dniu ${formatDate(eventData.date)}.`;
                newsDetails = `${eventData.originalSubject} > ${eventData.substitutionSubject} (${eventData.substitutedTeacher} > ${eventData.substitutingTeacher}) (lekcja ${eventData.lesson})`;
            } else if (type === 'cancelled') {
                const actionVerb = isEdit ? 'Zmieniono odwo≈Çanie' : 'Odwo≈Çano';
                newsAction = `${actionVerb} lekcjƒô ${eventData.subject || ''} w dniu ${formatDate(eventData.date)}`;
                newsDetails = `(lekcja ${eventData.lesson})`;
            } else if (type === 'quiz') {
                const actionVerb = isEdit ? 'Zmieniono' : 'Dodano';
                newsAction = `${actionVerb} wydarzenie w dniu ${formatDate(eventData.date)}: Kartk√≥wka`;
                newsDetails = `Przedmiot: ${eventData.subject} (lekcja ${eventData.lesson})`;
            } else if (type === 'exam') {
                const actionVerb = isEdit ? 'Zmieniono' : 'Dodano';
                newsAction = `${actionVerb} wydarzenie w dniu ${formatDate(eventData.date)}: Sprawdzian`;
                newsDetails = `Przedmiot: ${eventData.subject} (lekcja ${eventData.lesson})`;
            } else if (type === 'holiday') {
                newsAction = isEdit ? 'Zmieniono dzie≈Ñ wolny' : 'Dodano dzie≈Ñ wolny';
                const dateRange = eventData.startDate === eventData.endDate 
                    ? `w dniu ${formatDate(eventData.startDate)}`
                    : `od ${formatDate(eventData.startDate)} do ${formatDate(eventData.endDate)}`;
                newsDetails = `"${eventData.title}" ${dateRange}`;
            }
            
            // Add new/updated event
            let dateKey;
            
            if (type === 'absence' || type === 'holiday' || type === 'class-absence') {
                const startDate = new Date(eventData.startDate);
                const endDate = new Date(eventData.endDate);
                
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    dateKey = formatDateForStorage(d);
                    
                    if (!events[dateKey]) {
                        events[dateKey] = [];
                    }
                    
                    const eventCopy = {...eventData};
                    eventCopy.date = dateKey;
                    events[dateKey].push(eventCopy);
                }
            } else {
                dateKey = eventData.date;
                
                if (!events[dateKey]) {
                    events[dateKey] = [];
                }
                
                events[dateKey].push(eventData);
            }
            
            addNewsItem(newsAction, newsDetails).then(() => {
                saveEvents().then(() => {
                    initCalendar();
                    eventModal.style.display = 'none';
                    resetEditingContext();
                });
            });
        }
        
        // Reset editing context
        function resetEditingContext() {
            currentEditingEvent = null;
            currentEditingDate = null;
            currentEditingIndex = null;
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }
        
        // Format date and time for display
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('pl-PL');
        }
        
        // Format date for storage (YYYY-MM-DD)
        function formatDateForStorage(date) {
            return date.toISOString().split('T')[0];
        }
        
        // Event listeners for tabs
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Event listeners
        monthSelect.addEventListener('change', updateCalendarFromSelector);
        addEventBtn.addEventListener('click', () => showEventForm());
        closeModal.addEventListener('click', () => {
            eventModal.style.display = 'none';
            resetEditingContext();
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === eventModal) {
                eventModal.style.display = 'none';
                resetEditingContext();
            }
        });
        
        initCalendar();
    </script>
</body>
</html>
